<!DOCTYPE html>
<html lang="en">

<head>
    <script>
        // for search plugin notably
        const base_url = "https://fzaca.github.io/pharox/";
    </script>
    <script>
        const darkTheme = window.matchMedia("(prefers-color-scheme: dark)");
        darkTheme.onchange = (e) => {
            if (e.matches) {
                document.documentElement.classList.add("dark")
                localStorage.theme = 'dark';
            } else {
                document.documentElement.classList.remove("dark")
                localStorage.removeItem("theme")
            }
        };

        // On page load. Priotiry to lcaolStorage
        if (localStorage.theme === "dark") {
            document.documentElement.classList.add("dark")
        } else if (localStorage.theme === "light") {
            document.documentElement.classList.remove("dark")
        } else if (darkTheme.matches) {
            document.documentElement.classList.add("dark")
        } else {
            document.documentElement.classList.remove("dark")
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Build a PostgreSQL Adapter - Pharox Toolkit</title>
    


<title>Build a PostgreSQL Adapter</title>



<meta name="description" content="Implement the IStorage contract using PostgreSQL and SQLAlchemy as an example backend.">







<link rel="canonical" href="https://fzaca.github.io/pharox/how-to/postgres-adapter/">


<!-- Open Graph (Facebook, LinkedIn) -->

<meta property="og:title" content="Build a PostgreSQL Adapter">



<meta property="og:description" content="Implement the IStorage contract using PostgreSQL and SQLAlchemy as an example backend.">



<meta property="og:url" content="https://fzaca.github.io/pharox/how-to/postgres-adapter/">






<!-- Twitter Card -->

<meta name="twitter:title" content="Build a PostgreSQL Adapter">



<meta name="twitter:description" content="Implement the IStorage contract using PostgreSQL and SQLAlchemy as an example backend.">




<!-- JSON-LD Structured Data -->

<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "Build a PostgreSQL Adapter",
    "url": "https://fzaca.github.io/pharox/how-to/postgres-adapter/",
    "description": "Implement the IStorage contract using PostgreSQL and SQLAlchemy as an example backend.",
    
    
    
    
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://fzaca.github.io/pharox/how-to/postgres-adapter/"
    },
    
    
  }
  </script>



    <link rel="icon" href="../../img/favicon.ico">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/geist.css" rel="stylesheet">
    
    <link href="../../css/pygments/github-dark.css" rel="stylesheet">
    
    <link href="../../assets/_mkdocstrings.css" rel="stylesheet">
    <link href="../../assets/shadcn/highlight.css" rel="stylesheet">

    <script src="../../js/callbacks.js"></script>

    

    

    

</head>

<body class="w-screen overflow-x-hidden bg-foreground md:bg-background text-foreground scroll-smooth m-0 p-0">
    <div id="inner-body"
        class="min-h-screen bg-background origin-[top_center_0px] transition-all duration-500 ease-[cubic-bezier(0.32,0.72,0,1)]">
        <header
    class="border-grid sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
    <div class="w-full mx-auto 3xl:max-w-8xl">
        <div
            class="xl:px-6 h-14 w-full max-w-8xl mx-auto px-4 border-x border-grid flex flex-row justify-between items-center">
            <div class="mr-4 hidden md:flex">
                <a href="/" class="mr-4 flex items-center gap-2 lg:mr-6">
                    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"
    class="h-6 w-6">
    <rect width="256" height="256" fill="none"></rect>
    <line x1="208" y1="128" x2="128" y2="208" fill="none" stroke="currentColor" stroke-linecap="round"
        stroke-linejoin="round" stroke-width="32"></line>
    <line x1="192" y1="40" x2="40" y2="192" fill="none" stroke="currentColor" stroke-linecap="round"
        stroke-linejoin="round" stroke-width="32"></line>
</svg>

                    <h1 class="hidden lg:inline-block font-bold text-md">
                        
                        Pharox Toolkit
                        
                    </h1>
                </a>
            </div>
            <button
                class="cursor-pointer inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md font-medium transition-colors focus-visible:outline-none focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:size-4 [&amp;_svg]:shrink-0 hover:text-accent-foreground py-2 -ml-2 mr-2 h-8 w-8 px-0 text-base hover:bg-transparent focus-visible:bg-transparent focus-visible:ring-0 focus-visible:ring-offset-0 md:hidden"
                type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-:R15u6ja:"
                data-state="closed" onclick="onMobileMenuButtonClick(event)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="!size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5m-16.5 6.75h16.5"></path>
                </svg>
                <span class="sr-only">Toggle Menu</span>
            </button>
            <div class="flex flex-1 items-center justify-between gap-2 md:justify-end">
                <button onclick="onSearchBarClick(event)"
    class="cursor-pointer inline-flex items-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:size-4 [&amp;_svg]:shrink-0 border border-input hover:bg-accent hover:text-accent-foreground px-4 py-2 relative h-8 w-full justify-start rounded-[0.5rem] bg-muted/50 text-sm font-normal text-muted-foreground shadow-none sm:pr-12 md:w-40 lg:w-56 xl:w-64">
    <span class="hidden lg:inline-flex">Search documentation...</span>
    <span class="inline-flex lg:hidden">Search...</span>
    <kbd
        class="pointer-events-none absolute right-[0.3rem] top-[0.3rem] hidden h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium opacity-100 sm:flex">
        <span class="text-xs">⌘</span>K
    </kbd>
</button>
<dialog id="search-dialog" onclick="onSearchDialogClick(event)"
    class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-background rounded-lg shadow-lg border overflow-hidden p-0">
    <div class="w-lg gap-4">
        <div class="flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground">
            <div class="w-full flex items-center border-b px-3" cmdk-input-wrapper="">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="mr-2 h-4 w-4 shrink-0 opacity-50">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
                <!-- <script>
                    let debounceTimer;
                    const onInputHandler = function (event) {
                        const query = event.target.value;
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            if (searchWorker && (query.length > 2)) {
                                console.log(`Posting message { "query": "${query}" }`)
                                // https://lunrjs.com/guides/searching.html
                                // we should append a wilcard and also a boost on exact term
                                const lunrQuery = `${query}^10 ${query}* ${query}~1`;
                                searchWorker.postMessage({ "query": lunrQuery });
                            } else if (query.length > 2) {
                                console.warn("searchWorker is not defined")
                            } else {
                                const results = document.getElementById("mkdocs-search-results");
                                if (results) {
                                    while (results.firstChild) {
                                        results.removeChild(results.firstChild);
                                    }
                                }
                            }
                        }, 300);
                    };
                </script> -->
                <input
                    class="flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50"
                    placeholder="Type a command or search..." autocomplete="off" autocorrect="off" spellcheck="false"
                    aria-autocomplete="list" role="combobox" aria-expanded="true" type="text" value=""
                    oninput="onInputHandler(event)">
            </div>
        </div>
        <div id="mkdocs-search-results" class="max-h-[300px] overflow-y-auto overflow-x-hidden">
            <!-- search results go there -->
        </div>
    </div>
</dialog>
<script>
    document.removeEventListener("keydown", searchShortcutHandler);
    document.addEventListener("keydown", searchShortcutHandler);
</script>
                <div class="flex items-center gap-0.5">
                    
                    <button
                        class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-accent hover:text-accent-foreground h-8 w-8 px-0"><a
                            target="_blank" rel="noreferrer" href="https://github.com/fzaca/pharox">
                            
                            <svg viewBox="0 0 438.549 438.549" class="h-4 w-4">
    <path fill="currentColor"
        d="M409.132 114.573c-19.608-33.596-46.205-60.194-79.798-79.8-33.598-19.607-70.277-29.408-110.063-29.408-39.781 0-76.472 9.804-110.063 29.408-33.596 19.605-60.192 46.204-79.8 79.8C9.803 148.168 0 184.854 0 224.63c0 47.78 13.94 90.745 41.827 128.906 27.884 38.164 63.906 64.572 108.063 79.227 5.14.954 8.945.283 11.419-1.996 2.475-2.282 3.711-5.14 3.711-8.562 0-.571-.049-5.708-.144-15.417a2549.81 2549.81 0 01-.144-25.406l-6.567 1.136c-4.187.767-9.469 1.092-15.846 1-6.374-.089-12.991-.757-19.842-1.999-6.854-1.231-13.229-4.086-19.13-8.559-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-.951-2.568-2.098-3.711-3.429-1.142-1.331-1.997-2.663-2.568-3.997-.572-1.335-.098-2.43 1.427-3.289 1.525-.859 4.281-1.276 8.28-1.276l5.708.853c3.807.763 8.516 3.042 14.133 6.851 5.614 3.806 10.229 8.754 13.846 14.842 4.38 7.806 9.657 13.754 15.846 17.847 6.184 4.093 12.419 6.136 18.699 6.136 6.28 0 11.704-.476 16.274-1.423 4.565-.952 8.848-2.383 12.847-4.285 1.713-12.758 6.377-22.559 13.988-29.41-10.848-1.14-20.601-2.857-29.264-5.14-8.658-2.286-17.605-5.996-26.835-11.14-9.235-5.137-16.896-11.516-22.985-19.126-6.09-7.614-11.088-17.61-14.987-29.979-3.901-12.374-5.852-26.648-5.852-42.826 0-23.035 7.52-42.637 22.557-58.817-7.044-17.318-6.379-36.732 1.997-58.24 5.52-1.715 13.706-.428 24.554 3.853 10.85 4.283 18.794 7.952 23.84 10.994 5.046 3.041 9.089 5.618 12.135 7.708 17.705-4.947 35.976-7.421 54.818-7.421s37.117 2.474 54.823 7.421l10.849-6.849c7.419-4.57 16.18-8.758 26.262-12.565 10.088-3.805 17.802-4.853 23.134-3.138 8.562 21.509 9.325 40.922 2.279 58.24 15.036 16.18 22.559 35.787 22.559 58.817 0 16.178-1.958 30.497-5.853 42.966-3.9 12.471-8.941 22.457-15.125 29.979-6.191 7.521-13.901 13.85-23.131 18.986-9.232 5.14-18.182 8.85-26.84 11.136-8.662 2.286-18.415 4.004-29.263 5.146 9.894 8.562 14.842 22.077 14.842 40.539v60.237c0 3.422 1.19 6.279 3.572 8.562 2.379 2.279 6.136 2.95 11.276 1.995 44.163-14.653 80.185-41.062 108.068-79.226 27.88-38.161 41.825-81.126 41.825-128.906-.01-39.771-9.818-76.454-29.414-110.049z">
    </path>
</svg>
                            <span class="sr-only">GitHub</span>
                            
                        </a>
                    </button>
                    
                    <button
                        class="cursor-pointer inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-accent hover:text-accent-foreground py-2 group/toggle h-8 w-8 px-0"
                        onclick="onThemeSwitch(event)">
                        
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round"
    class="h-4 w-4 dark:hidden not-dark:block">
    <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
</svg>
                        
                        
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round"
    class="h-4 w-4 not-dark:hidden dark:block">
    <circle cx="12" cy="12" r="4" />
    <path d="M12 2v2" />
    <path d="M12 20v2" />
    <path d="m4.93 4.93 1.41 1.41" />
    <path d="m17.66 17.66 1.41 1.41" />
    <path d="M2 12h2" />
    <path d="M20 12h2" />
    <path d="m6.34 17.66-1.41 1.41" />
    <path d="m19.07 4.93-1.41 1.41" />
</svg>
                        
                        <span class="sr-only">Toggle theme</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="border-grid flex flex-1 flex-col">
            <div class="w-full mx-auto 3xl:max-w-8xl">
                <div
                    class="px-4 w-full max-w-8xl mx-auto xl:px-6 flex-1 items-start md:grid md:grid-cols-[220px_minmax(0,1fr)] md:gap-6 lg:grid-cols-[240px_minmax(0,1fr)] lg:gap-10">
                    <aside
                        class="border-grid fixed top-14 z-30 hidden h-[calc(100vh-3.55rem)] w-full shrink-0 border-r md:sticky md:block">
                        <div
    class="no-scrollbar [&::-webkit-scrollbar]:hidden h-full overflow-auto py-6 pr-4 lg:py-8 flex flex-col gap-[.125rem]">
    
    
    

    
    
    <a href="../.." 
    class="text-sm flex shrink-0 h-8 w-full items-center rounded-lg px-2 text-foreground underline-offset-2 font-normal hover:bg-accent hover:text-accent-foreground data-active:bg-accent data-active:font-medium data-active:text-accent-foreground">
    
    Home
    

    

    

    
</a>
    
    


    
    
    <div class="flex flex-col gap-1 mt-5 first:mt-0">
        <h4 class="rounded-md px-2 py-1 text-sm font-semibold">Getting Started</h4>
        <div class="grid grid-flow-row auto-rows-max gap-[.125rem]">
            
            <a href="../../getting-started/quickstart/" 
    class="text-sm flex shrink-0 h-8 w-full items-center rounded-lg px-2 text-foreground underline-offset-2 font-normal hover:bg-accent hover:text-accent-foreground data-active:bg-accent data-active:font-medium data-active:text-accent-foreground">
    
    Quickstart
    

    

    

    
</a>
            
        </div>
    </div>
    
    
    
    <div class="flex flex-col gap-1 mt-5 first:mt-0">
        <h4 class="rounded-md px-2 py-1 text-sm font-semibold">How-To Guides</h4>
        <div class="grid grid-flow-row auto-rows-max gap-[.125rem]">
            
            <a href="../embed-worker/" 
    class="text-sm flex shrink-0 h-8 w-full items-center rounded-lg px-2 text-foreground underline-offset-2 font-normal hover:bg-accent hover:text-accent-foreground data-active:bg-accent data-active:font-medium data-active:text-accent-foreground">
    
    Embed Pharox in a Worker
    

    

    

    
</a>
            
            <a href="../health-sweeps/" 
    class="text-sm flex shrink-0 h-8 w-full items-center rounded-lg px-2 text-foreground underline-offset-2 font-normal hover:bg-accent hover:text-accent-foreground data-active:bg-accent data-active:font-medium data-active:text-accent-foreground">
    
    Run Health Checks at Scale
    

    

    

    
</a>
            
            <a href="../lifecycle-hooks/" 
    class="text-sm flex shrink-0 h-8 w-full items-center rounded-lg px-2 text-foreground underline-offset-2 font-normal hover:bg-accent hover:text-accent-foreground data-active:bg-accent data-active:font-medium data-active:text-accent-foreground">
    
    Instrument Lifecycle Hooks
    

    

    

    
</a>
            
            <a href="./" data-active 
    class="text-sm flex shrink-0 h-8 w-full items-center rounded-lg px-2 text-foreground underline-offset-2 font-normal hover:bg-accent hover:text-accent-foreground data-active:bg-accent data-active:font-medium data-active:text-accent-foreground">
    
    Build a PostgreSQL Adapter
    

    

    

    
</a>
            
        </div>
    </div>
    
    
    
    <div class="flex flex-col gap-1 mt-5 first:mt-0">
        <h4 class="rounded-md px-2 py-1 text-sm font-semibold">Concepts</h4>
        <div class="grid grid-flow-row auto-rows-max gap-[.125rem]">
            
            <a href="../../health-checks/" 
    class="text-sm flex shrink-0 h-8 w-full items-center rounded-lg px-2 text-foreground underline-offset-2 font-normal hover:bg-accent hover:text-accent-foreground data-active:bg-accent data-active:font-medium data-active:text-accent-foreground">
    
    Health Toolkit
    

    

    

    
</a>
            
            <a href="../../models/" 
    class="text-sm flex shrink-0 h-8 w-full items-center rounded-lg px-2 text-foreground underline-offset-2 font-normal hover:bg-accent hover:text-accent-foreground data-active:bg-accent data-active:font-medium data-active:text-accent-foreground">
    
    Models & Filters
    

    

    

    
</a>
            
            <a href="../../proxy-manager/" 
    class="text-sm flex shrink-0 h-8 w-full items-center rounded-lg px-2 text-foreground underline-offset-2 font-normal hover:bg-accent hover:text-accent-foreground data-active:bg-accent data-active:font-medium data-active:text-accent-foreground">
    
    Proxy Manager Deep Dive
    

    

    

    
</a>
            
            <a href="../../storage/" 
    class="text-sm flex shrink-0 h-8 w-full items-center rounded-lg px-2 text-foreground underline-offset-2 font-normal hover:bg-accent hover:text-accent-foreground data-active:bg-accent data-active:font-medium data-active:text-accent-foreground">
    
    Storage Adapters
    

    

    

    
</a>
            
        </div>
    </div>
    
    
    
    <div class="flex flex-col gap-1 mt-5 first:mt-0">
        <h4 class="rounded-md px-2 py-1 text-sm font-semibold">Reference</h4>
        <div class="grid grid-flow-row auto-rows-max gap-[.125rem]">
            
            <a href="../../reference/bootstrap/" 
    class="text-sm flex shrink-0 h-8 w-full items-center rounded-lg px-2 text-foreground underline-offset-2 font-normal hover:bg-accent hover:text-accent-foreground data-active:bg-accent data-active:font-medium data-active:text-accent-foreground">
    
    Bootstrap Helpers
    

    

    

    
</a>
            
            <a href="../../reference/proxy-manager/" 
    class="text-sm flex shrink-0 h-8 w-full items-center rounded-lg px-2 text-foreground underline-offset-2 font-normal hover:bg-accent hover:text-accent-foreground data-active:bg-accent data-active:font-medium data-active:text-accent-foreground">
    
    ProxyManager API
    

    

    

    
</a>
            
        </div>
    </div>
    
    
    
</div>
                    </aside>
                    <main class="relative py-6 lg:gap-10 lg:py-8 xl:grid xl:grid-cols-[1fr_300px]">
                        <div class="mx-auto w-full min-w-0 xl:max-w-2xl">
                            <article class="typography w-full">
    
    <div class="mb-4 flex items-center space-x-1 text-sm leading-none text-muted-foreground">
    


<span class="truncate">How-To Guides</span>


<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right h-3.5 w-3.5">
    <path d="m9 18 6-6-6-6"></path>
</svg>
<div class="text-foreground">Build a PostgreSQL Adapter</div>

</div>
    
    
    <h1 class="tracking-tight">Build a PostgreSQL Adapter</h1>
    
    
    <h1 id="build-a-postgresql-adapter">Build a PostgreSQL Adapter<a class="headerlink" href="#build-a-postgresql-adapter" title="Permanent link">&para;</a></h1>
<p>Pharox ships with an in-memory adapter for tests and demos. This guide shows how
to create a PostgreSQL-backed implementation using SQLAlchemy. The same approach
applies to other ORMs or async drivers—swap libraries as needed.</p>
<div class="admonition note">
<p class="admonition-title">Scope</p>
<p>This is a reference implementation you can adapt to your organisation's
standards. It focuses on the required <code>IStorage</code> methods and leaves schema
migrations to tools like Alembic. A maintained template (code + migrations +
Docker Compose) lives under <code>examples/postgres/</code> in the repository so you
can clone it directly.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Install optional dependencies</p>
<p>The toolkit exposes a <code>postgres</code> extra that bundles SQLAlchemy, psycopg, and
Alembic. Install it via <code>pip install 'pharox[postgres]'</code> (or
<code>poetry install --extras postgres</code>) before running the examples below.</p>
</div>
<h2 id="1-define-the-schema">1. Define the Schema<a class="headerlink" href="#1-define-the-schema" title="Permanent link">&para;</a></h2>
<p>Create tables for pools, proxies, consumers, and leases. Below is a simplified
schema that captures the fields Pharox expects.</p>
<pre class="codehilite"><code class="language-sql">CREATE TABLE proxy_pool (
    id UUID PRIMARY KEY,
    name TEXT UNIQUE NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE consumer (
    id UUID PRIMARY KEY,
    name TEXT UNIQUE NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE proxy (
    id UUID PRIMARY KEY,
    pool_id UUID NOT NULL REFERENCES proxy_pool(id),
    host TEXT NOT NULL,
    port INTEGER NOT NULL,
    protocol TEXT NOT NULL,
    status TEXT NOT NULL,
    max_concurrency INTEGER NOT NULL DEFAULT 1,
    current_leases INTEGER NOT NULL DEFAULT 0,
    asn INTEGER,
    country TEXT,
    source TEXT,
    latitude DOUBLE PRECISION,
    longitude DOUBLE PRECISION,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE lease (
    id UUID PRIMARY KEY,
    proxy_id UUID NOT NULL REFERENCES proxy(id),
    consumer_id UUID NOT NULL REFERENCES consumer(id),
    status TEXT NOT NULL,
    acquired_at TIMESTAMPTZ NOT NULL,
    expires_at TIMESTAMPTZ NOT NULL,
    released_at TIMESTAMPTZ
);</code></pre>
<p>Add indexes that match your filter workloads (e.g., <code>proxy(pool_id, status)</code>,
geospatial indexes for latitude/longitude).</p>
<h2 id="2-implement-the-adapter">2. Implement the Adapter<a class="headerlink" href="#2-implement-the-adapter" title="Permanent link">&para;</a></h2>
<p>Use SQLAlchemy's ORM or Core—below we use Core for clarity.</p>
<pre class="codehilite"><code class="language-python">from __future__ import annotations

from datetime import UTC, datetime, timedelta
from typing import Optional
from uuid import uuid4

from sqlalchemy import select, update
from sqlalchemy.dialects.postgresql import insert
from sqlalchemy.engine import Connection

from pharox.models import HealthCheckResult, Lease, Proxy, ProxyFilters
from pharox.storage import IStorage

from .tables import consumer_table, lease_table, pool_table, proxy_table

class PostgresStorage(IStorage):
    def __init__(self, conn: Connection):
        self._conn = conn

    def find_available_proxy(
        self, pool_name: str, filters: Optional[ProxyFilters] = None
    ) -&gt; Optional[Proxy]:
        query = (
            select(proxy_table)
            .join(pool_table, proxy_table.c.pool_id == pool_table.c.id)
            .where(
                pool_table.c.name == pool_name,
                proxy_table.c.status == "active",
                proxy_table.c.current_leases &lt; proxy_table.c.max_concurrency,
            )
            .order_by(proxy_table.c.created_at.asc())
            .limit(1)
        )

        if filters:
            if filters.country:
                query = query.where(proxy_table.c.country == filters.country)
            if filters.source:
                query = query.where(proxy_table.c.source == filters.source)
            if filters.asn is not None:
                query = query.where(proxy_table.c.asn == filters.asn)

        row = self._conn.execute(query).m.fetchone()
        return Proxy.model_validate(row) if row else None

    def create_lease(
        self, proxy: Proxy, consumer_name: str, duration_seconds: int
    ) -&gt; Lease:
        expires_at = datetime.now(UTC) + timedelta(seconds=duration_seconds)

        consumer_id = self.ensure_consumer(consumer_name)

        lease_id = uuid4()
        self._conn.execute(
            lease_table.insert().values(
                id=lease_id,
                proxy_id=proxy.id,
                consumer_id=consumer_id,
                status="active",
                acquired_at=datetime.now(UTC),
                expires_at=expires_at,
            )
        )
        self._conn.execute(
            update(proxy_table)
            .where(proxy_table.c.id == proxy.id)
            .values(current_leases=proxy.current_leases + 1)
        )

        return Lease(
            id=lease_id,
            proxy_id=proxy.id,
            consumer_id=consumer_id,
            status="active",
            acquired_at=datetime.now(UTC),
            expires_at=expires_at,
        )

    def ensure_consumer(self, consumer_name: str):
        stmt = (
            insert(consumer_table)
            .values(id=uuid4(), name=consumer_name)
            .on_conflict_do_nothing(index_elements=["name"])
            .returning(consumer_table.c.id)
        )
        result = self._conn.execute(stmt)
        row = result.fetchone()
        if row:
            return row.id

        query = select(consumer_table.c.id).where(consumer_table.c.name == consumer_name)
        return self._conn.execute(query).scalar_one()

    def release_lease(self, lease: Lease) -&gt; None:
        self._conn.execute(
            update(lease_table)
            .where(lease_table.c.id == lease.id)
            .values(status="released", released_at=datetime.now(UTC))
        )
        self._conn.execute(
            update(proxy_table)
            .where(proxy_table.c.id == lease.proxy_id)
            .values(current_leases=proxy_table.c.current_leases - 1)
        )

    def cleanup_expired_leases(self) -&gt; int:
        now = datetime.now(UTC)
        query = select(lease_table.c.id, lease_table.c.proxy_id).where(
            lease_table.c.status == "active",
            lease_table.c.expires_at &lt;= now,
        )
        expired = list(self._conn.execute(query))
        for lease_id, proxy_id in expired:
            self._conn.execute(
                update(lease_table)
                .where(lease_table.c.id == lease_id)
                .values(status="expired", released_at=now)
            )
            self._conn.execute(
                update(proxy_table)
                .where(proxy_table.c.id == proxy_id)
                .values(current_leases=proxy_table.c.current_leases - 1)
            )
        return len(expired)

    def apply_health_check_result(
        self, result: HealthCheckResult
    ) -&gt; Optional[Proxy]:
        self._conn.execute(
            update(proxy_table)
            .where(proxy_table.c.id == result.proxy_id)
            .values(
                status=result.status.value,
                checked_at=result.checked_at,
                last_latency_ms=result.latency_ms,
            )
        )
        refreshed = self._conn.execute(
            select(proxy_table).where(proxy_table.c.id == result.proxy_id)
        ).m.fetchone()
        return Proxy.model_validate(refreshed) if refreshed else None</code></pre>
<p>The full implementation should guard against race conditions (e.g., using
<code>FOR UPDATE</code> locks) and handle geospatial filters. Start simple, then iterate
based on scale.</p>
<div class="admonition tip">
<p class="admonition-title">Health result contract</p>
<p>Align your <code>apply_health_check_result</code> with the guidance in
<a href="../../storage/#apply_health_check_result-best-practices">Storage › Best Practices</a>
so every adapter exposes consistent status/latency data to the toolkit.</p>
</div>
<h2 id="3-run-contract-tests">3. Run Contract Tests<a class="headerlink" href="#3-run-contract-tests" title="Permanent link">&para;</a></h2>
<p>Before adopting the adapter in production, reuse the storage contract suite
bundled with Pharox:</p>
<pre class="codehilite"><code class="language-python">import pytest
from sqlalchemy import create_engine, text

from pharox.storage.postgres import PostgresStorage
from pharox.models import Proxy, ProxyPool
from pharox.tests.adapters import (
    StorageContractFixtures,
    storage_contract_suite,
)

engine = create_engine("postgresql+psycopg://user:pass@localhost/pharox")


def make_storage() -&gt; PostgresStorage:
    with engine.begin() as conn:
        conn.execute(text("TRUNCATE lease, proxy, consumer, proxy_pool RESTART IDENTITY"))
    return PostgresStorage(engine)


def seed_pool(storage: PostgresStorage, pool: ProxyPool) -&gt; ProxyPool:
    with engine.begin() as conn:
        conn.execute(
            text(
                "INSERT INTO proxy_pool (id, name, description) VALUES (:id, :name, :description)"
            ),
            {"id": str(pool.id), "name": pool.name, "description": pool.description},
        )
    return pool


def seed_proxy(storage: PostgresStorage, proxy: Proxy) -&gt; Proxy:
    with engine.begin() as conn:
        conn.execute(
            text(
                """
                INSERT INTO proxy (
                    id, pool_id, host, port, protocol, status, max_concurrency,
                    current_leases, country, source, city
                )
                VALUES (
                    :id, :pool_id, :host, :port, :protocol, :status,
                    :max_concurrency, 0, :country, :source, :city
                )
                """
            ),
            {
                "id": str(proxy.id),
                "pool_id": str(proxy.pool_id),
                "host": proxy.host,
                "port": proxy.port,
                "protocol": proxy.protocol.value,
                "status": proxy.status.value,
                "max_concurrency": proxy.max_concurrency,
                "country": proxy.country,
                "source": proxy.source,
                "city": proxy.city,
            },
        )
    return proxy


@pytest.mark.contract
def test_postgres_storage_contract():
    fixtures = StorageContractFixtures(
        make_storage=make_storage,
        seed_pool=seed_pool,
        seed_proxy=seed_proxy,
    )
    storage_contract_suite(fixtures)</code></pre>
<p>Set <code>PHAROX_TEST_POSTGRES_URL</code> to point at a disposable database (e.g.,
<code>postgresql+psycopg://pharox:pharox@localhost:5439/pharox</code>) and run
<code>poetry run pytest tests/test_storage_contract_postgres.py</code> in this repo to see
the suite in action.</p>
<div class="admonition tip">
<p class="admonition-title">Spin up PostgreSQL fast</p>
<p>Use <code>docker compose up postgres</code> from the <code>/examples/postgres</code> directory
(see below) to boot a development instance with migrations pre-applied.</p>
</div>
<h2 id="4-share-as-an-example">4. Share as an Example<a class="headerlink" href="#4-share-as-an-example" title="Permanent link">&para;</a></h2>
<p>Pharox already ships <code>pharox.storage.postgres.PostgresStorage</code> plus the
<code>examples/postgres/</code> toolkit (docker-compose, migrations, and shims). Copy that
directory into your service to kick-start a production implementation, and send
improvements upstream (docs, migrations, tests) so the template keeps getting
better. If you need to publish an internal fork, keep the README up to date so
new teams can bootstrap quickly.</p>
</article>
                        </div>
                        <div class="hidden text-sm xl:block">
                            <div class="sticky top-20 -mt-6 pt-4">
    <div class="no-scrollbar h-full overflow-auto pb-10">
        <div class="space-y-2">
            <p class="font-medium">On This Page</p>
            <ul class="m-0 list-none">
                
                
                
                
                <li class="mt-0 pt-2">
                    <a class="inline-block no-underline transition-colors hover:text-foreground text-muted-foreground"
                        href="#1-define-the-schema">1. Define the Schema</a>
                    
                </li>
                
                <li class="mt-0 pt-2">
                    <a class="inline-block no-underline transition-colors hover:text-foreground text-muted-foreground"
                        href="#2-implement-the-adapter">2. Implement the Adapter</a>
                    
                </li>
                
                <li class="mt-0 pt-2">
                    <a class="inline-block no-underline transition-colors hover:text-foreground text-muted-foreground"
                        href="#3-run-contract-tests">3. Run Contract Tests</a>
                    
                </li>
                
                <li class="mt-0 pt-2">
                    <a class="inline-block no-underline transition-colors hover:text-foreground text-muted-foreground"
                        href="#4-share-as-an-example">4. Share as an Example</a>
                    
                </li>
                
                
                
                
            </ul>
        </div>
    </div>
</div>
                        </div>
                    </main>
                </div>
            </div>
            <dialog id="bottom-sidebar" data-closing="0"
    class="backdrop:bg-black backdrop:opacity-80 backdrop:transition-all backdrop:duration-500 text-foreground"
    onclick="onBottomSidebarDialogClick(event)">
    <div
        class="fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background max-h-[60svh] p-0 transition-transform duration-500 ease-[cubic-bezier(0.32,0.72,0,1)]">
        <div class="mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted"></div>
        <div class="overflow-auto p-6 space-y-3">
            
            

            <div class="flex flex-col">
                
                
                <a href="../.." class="text-base shrink-0">
    Home
</a>
                
                
            </div>
            

            <div class="flex flex-col">
                
                <div class="flex flex-col space-y-3 pt-4">
                    <h4 class="font-medium">Getting Started </h4>
                    
                    <a href="../../getting-started/quickstart/" class="text-base shrink-0">
    Quickstart
</a>
                    
                </div>
                
            </div>
            

            <div class="flex flex-col">
                
                <div class="flex flex-col space-y-3 pt-4">
                    <h4 class="font-medium">How-To Guides </h4>
                    
                    <a href="../embed-worker/" class="text-base shrink-0">
    Embed Pharox in a Worker
</a>
                    
                    <a href="../lifecycle-hooks/" class="text-base shrink-0">
    Instrument Lifecycle Hooks
</a>
                    
                    <a href="./" class="text-base shrink-0">
    Build a PostgreSQL Adapter
</a>
                    
                    <a href="../health-sweeps/" class="text-base shrink-0">
    Run Health Checks at Scale
</a>
                    
                </div>
                
            </div>
            

            <div class="flex flex-col">
                
                <div class="flex flex-col space-y-3 pt-4">
                    <h4 class="font-medium">Concepts </h4>
                    
                    <a href="../../proxy-manager/" class="text-base shrink-0">
    Proxy Manager Deep Dive
</a>
                    
                    <a href="../../models/" class="text-base shrink-0">
    Models & Filters
</a>
                    
                    <a href="../../storage/" class="text-base shrink-0">
    Storage Adapters
</a>
                    
                    <a href="../../health-checks/" class="text-base shrink-0">
    Health Toolkit
</a>
                    
                </div>
                
            </div>
            

            <div class="flex flex-col">
                
                <div class="flex flex-col space-y-3 pt-4">
                    <h4 class="font-medium">Reference </h4>
                    
                    <a href="../../reference/proxy-manager/" class="text-base shrink-0">
    ProxyManager API
</a>
                    
                    <a href="../../reference/bootstrap/" class="text-base shrink-0">
    Bootstrap Helpers
</a>
                    
                </div>
                
            </div>
            
            
        </div>
    </div>
</dialog>
        </div>
    </div> 
    
    <script src="../../assets/highlight.js"></script>
     
    
    <script src="../../search/main.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@2.3.0/dist/iconify-icon.min.js"></script>
    <script src="../../js/copy-button.js"></script>
</body>

</html>